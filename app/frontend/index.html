<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mini Twitter</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- BotÃ³n Dark Mode -->
    <button id="themeToggle" class="theme-btn">ğŸŒ™</button>

    <div class="app-container">
      <!-- ===== SIDEBAR IZQUIERDA ===== -->
      <nav class="sidebar">
        <ul>
          <li>ğŸ  Home</li>
          <li>ğŸ” Explore</li>
          <li>ğŸ”” Notifications</li>
          <li>âœ‰ï¸ Messages</li>
          <li>âš™ï¸ Settings</li>
        </ul>
      </nav>

      <!-- ===== COLUMNA CENTRAL (Timeline + Posts) ===== -->
      <main class="main">
        <h1>Mini Twitter</h1>

        <section class="post-message">
          <h2>Post Message</h2>
          <input id="message" placeholder="Message" />
          <button onclick="postMessage()">Post Message</button>
        </section>

        <section class="timeline-section">
          <h2>Timeline</h2>
          <ul id="timeline"></ul>
        </section>
      </main>

      <!-- ===== PANEL DERECHO ===== -->
      <aside class="rightbar">
        <h2>Trending</h2>
        <ul>
          <li>#ChatGPT</li>
          <li>#DarkMode</li>
          <li>#JavaScript</li>
          <li>#WebDev</li>
        </ul>
      </aside>
    </div>

    <script>
      const API = "http://192.168.59.101/backend";
      const MAX_MSG_LENGTH = 140;
      let skip = 0,
        limit = 20,
        loading = false;
      const timeline = document.getElementById("timeline");

      // Verificar usuario logueado
      const currentUser = JSON.parse(localStorage.getItem("currentUser"));
      if (!currentUser) window.location.href = "login.html";

      // --- Users ---
      async function createUser() {
        const username = document.getElementById("username").value.trim();
        if (!username) return alert("Enter a username!");
        await fetch(`${API}/users?username=${username}`, { method: "POST" });
        loadUsers();
      }

      async function loadUsers() {
        const res = await fetch(`${API}/users`);
        const users = await res.json();
        const ul = document.getElementById("users");
        ul.innerHTML = "";
        users.forEach((u) => {
          const li = document.createElement("li");
          li.textContent = u.username;
          ul.appendChild(li);
        });
      }

      // --- Message helper ---
      function createMessageElement(m) {
        const li = document.createElement("li");

        // Message text
        const textSpan = document.createElement("span");
        textSpan.textContent = `${m.username}: ${m.content}`;
        li.appendChild(textSpan);

        // Actions
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "actions";

        const likeBtn = document.createElement("button");
        likeBtn.textContent = `Like (${m.likes || 0})`;
        likeBtn.onclick = async () => {
          const username = document.getElementById("username").value.trim();
          if (!username) return alert("Enter your username to like messages");

          const res = await fetch(
            `${API}/messages/${m.id}/like?username=${username}`,
            { method: "POST" }
          );
          const data = await res.json();
          m.likes = data.likes;
          likeBtn.textContent = `Like (${m.likes})`;
        };
        actionsDiv.appendChild(likeBtn);

        const retweetBtn = document.createElement("button");
        retweetBtn.textContent = `Retweet (${m.retweets || 0})`;
        retweetBtn.onclick = async () => {
          const username = document.getElementById("username").value.trim();
          if (!username)
            return alert("Enter your username to retweet messages");

          const res = await fetch(
            `${API}/messages/${m.id}/retweet?username=${username}`,
            { method: "POST" }
          );
          const data = await res.json();
          m.retweets = data.retweets;
          retweetBtn.textContent = `Retweet (${m.retweets})`;
        };
        actionsDiv.appendChild(retweetBtn);

        li.appendChild(actionsDiv);
        return li;
      }

      // --- Load older messages ---
      async function loadOlderMessages() {
        if (loading) return;
        loading = true;

        try {
          const res = await fetch(
            `${API}/messages?skip=${skip}&limit=${limit}`
          );
          const messages = await res.json();
          if (messages.length === 0) return;

          messages.forEach((m) => {
            const li = createMessageElement(m);
            timeline.appendChild(li);
          });

          skip += messages.length;
        } catch (e) {
          console.error(e);
        } finally {
          loading = false;
        }
      }

      // --- Post a new message ---
      async function postMessage() {
        const username = document.getElementById("username").value.trim();
        let content = document.getElementById("message").value.trim();
        if (!username || !content)
          return alert("Username and message required!");
        if (content.length > MAX_MSG_LENGTH)
          content = content.slice(0, MAX_MSG_LENGTH) + "...";

        const res = await fetch(
          `${API}/messages?username=${username}&content=${content}`,
          { method: "POST" }
        );
        const message = await res.json();
        document.getElementById("message").value = "";

        const li = createMessageElement(message);
        timeline.prepend(li);
      }

      // Scroll event for pagination
      timeline.addEventListener("scroll", () => {
        if (
          timeline.scrollTop + timeline.clientHeight >=
          timeline.scrollHeight - 5
        ) {
          loadOlderMessages();
        }
      });

      // Initial load
      loadOlderMessages();
      loadUsers();
      const toggleBtn = document.getElementById("themeToggle");

      // Cambiar tema manualmente
      toggleBtn.onclick = () => {
        document.body.classList.toggle("dark");

        if (document.body.classList.contains("dark")) {
          localStorage.setItem("theme", "dark");
          toggleBtn.textContent = "â˜€ï¸";
        } else {
          localStorage.setItem("theme", "light");
          toggleBtn.textContent = "ğŸŒ™";
        }
      };

      // Cargar preferencia al abrir la pÃ¡gina
      if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark");
        toggleBtn.textContent = "â˜€ï¸";
      }
    </script>
  </body>
</html>
